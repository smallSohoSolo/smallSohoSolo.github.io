---
layout: post
title: "ASM文档翻译"
date: 2017-8-7
category: Android
tag: aop
typora-root-url: ../../myblog
---

## 2. 章节

这个章节说明了如何使用Core ASM API 生成并且修改编译Java字节码。开始首先介绍字节码的编译，之后指出相应的ASM接口，组件和工具去初始化和修改她们，并且有很多实用的例子。方法，注解和泛型的内容在下一章节说明。

### 2.1. 结构

#### 2.1.1. 概览 

字节码的结构是很简单的。并不像一个编译好的Application，字节码保留了结构信息和大多数的源代码符号。事实上，字节码中包括：

- 类的作用域（例如 public 或 private），名字，父类，接口和注解。
- 类中的每一个变量。包括每一个变量的作用域，名称，类型和注解。
- 类中的每一个方法和构造函数。每一个部分包括作用域，名称，返回值，参数和注解。并且也包括方法编译后的字节码。

源码和字节码有很多的不同

- 一个字节码文件仅描述一个类，当一个源码文件包含多个类的时候。举个例子一个源码文件中的一个类中包含一个内部类，那么他会被编译成两个字节码文件。一个是主类的，另外一个是内部类的。主类的文件中包含对他内部类的引用，并且非静态的内部类也持有对外部类的引用。
- 字节码文件并不包含注释，但是包含函数类，变量，方法和能被用于关联结构的额外信息的attribute。源于对Java5注解的介绍，对于相同作用的代码，attributes 大多数是没有用的。
- 字节码并不包含package和import的部分，所以所有的类型名称都要被完全的标记。

另一个非常重要的结构上的不同点是字节码中包含常量池。常量池是一个包括所有这个类中的numeric，string或者其他类型的常量的array。这些常量仅仅被定义一次，并且被类的全局持有引用。有幸的是ASM隐藏了所有跟常量池相关的细节问题，所以你不用为此苦恼。图2.1显示了字节码的结构，更精确的结构在第四节，Java虚拟机规范。

![](/img/2017-8-7/2-1.png)

<center>图2.1：字节码的整体结构</center>

另一个重要的不同是Java的类型在源码和字节码中的表示不同，下一节会谈到这些东西在字节码中的展示。

#### 2.1.2. 内部名称 

在很多情况下类和接口是有类型的。比如一个类的父类，一个类实现的接口，或者一个方法抛出的异常都不能被原始类型，数组类型，必要类和接口表示。这些类型在字节码中用内部名称表示。内部名称就是一个类的标准名称，点会被替换为斜杠。举个例子，String会被替换为java/lang/String。

#### 2.1.3. 类型描述符

内部名称仅仅用明确的类名或接口类型表示。在所有的其他情况，比如变量类型，Java用类型描述符号在字节码中进行表示。（如图2.2）

![](/img/2017-8-7/2-2.png)

<center>图2.2：字节码的整体结构</center>

基础类型的类型描述符是一个字母：Z 代表 boolean，C代表char，B代表byte，S代表short，I代表int，F代表float，J代表long，D代表double。类的类型描述符就是类的类型名称。L开头，分号结尾。例如String的类型描述符是Ljava/lang/String;。数组类型的描述符就是方括号开头跟上类型描述符，多维数组就是多个方括号。

#### 2.1.4. 方法描述符

一个方法描述符是一组类型描述符的集合，包括变量类型，返回值类型用一整个字符串来表示。一个方法描述符用左括号开头，接着是变量的类型描述符，然后右括号结束。紧跟着返回值的类型描述符。V代表void。

![](/img/2017-8-7/2-3.png)

<center>图2.3：方法描述符势力</center>

一旦你知道类型描述符怎么工作，理解方法描述符更加简单。举个例子，(I)I 描述了一参数为int，并且返回值是int的方法。如图2.3给了一些方法描述符的例子。

### 2.2. 接口和组件

#### 2.2.1. 介绍

ASM API 初始化和处理字节码是基于ClassVisitor虚类（如图2.4）。每一个